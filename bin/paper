#!/bin/bash

set -x

sleep 60 

for doc in sdut lat TodaysPaper; do
    pushd /
    cp ${doc}.pdf ${doc}-prev.pdf
    wget -N https://cloud.jimcoggeshall.com/${doc}.pdf
    diff -q ${doc}.pdf ${doc}-prev.pdf && exit 1

    workdir=$(uuidgen)/${doc}

    mkdir -p "$workdir/img"
    pushd "$workdir/img"

    pdfseparate /${doc}.pdf ${doc}%03d.pdf

    find . -name '*.pdf' | while read f; do
        pdftocairo -png -cropbox -singlefile -r 250 "$f" "$(basename $f '.pdf')"
        rm -f "$f"
    done

    popd

    pushd "$workdir"

    find img -name '*.png' |\
        sort -n |\
        awk 'BEGIN { \
            printf("var pagesOrig = [\n"); \
        } \
        NR == 1 { \
            printf("  \"%s\"", $0); \
        } \
        NR > 1 { \
            printf(",\n  \"%s\"", $0); \
        } \
        END { \
            printf("\n];\n"); \
        }' > list.js


    find img -name '*.png' | sort -n | head -1 | while read f; do
        ln -sf "$f" front.png
    done

    chmod -R 777 img
    chmod -R 777 list.js
    chmod -R 777 front.png

    rm -rf /var/www/jimcoggeshall.com/papers/${doc}/img || :
    rm -rf /var/www/jimcoggeshall.com/papers/${doc}/list.js || :
    rm /var/www/jimcoggeshall.com/papers/${doc}/front.png || :
    mv img /var/www/jimcoggeshall.com/papers/${doc}
    mv list.js /var/www/jimcoggeshall.com/papers/${doc}
    mv front.png /var/www/jimcoggeshall.com/papers/${doc}

    popd

    rm -rf "$workdir"
done

ln -sf ../papers/TodaysPaper/list.js /var/www/jimcoggeshall.com/paper/list.js
ln -sf ../papers/TodaysPaper/img /var/www/jimcoggeshall.com/paper/img
