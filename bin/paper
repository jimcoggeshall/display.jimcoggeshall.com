#!/bin/bash

set -x

sleep 60 

pushd /
cp TodaysPaper.pdf TodaysPaper-prev.pdf
wget -N https://cloud.jimcoggeshall.com/TodaysPaper.pdf
diff -q TodaysPaper.pdf TodaysPaper-prev.pdf || exit 1

workdir=$(uuidgen)

mkdir -p "$workdir/img"
pushd "$workdir/img"

pdfseparate /TodaysPaper.pdf TodaysPaper%03d.pdf

find . -name '*.pdf' | while read f; do
    pdftocairo -png -singlefile -r 150 "$f" "$(basename $f '.pdf')"
    rm -f "$f"
done

popd

pushd "$workdir"

find img -name '*.png' |\
    sort -n |\
	   awk 'BEGIN { \
        printf("var pagesOrig = [\n"); \
    } \
    NR == 1 { \
        printf("  \"%s\"", $0); \
    } \
    NR > 1 { \
        printf(",\n  \"%s\"", $0); \
    } \
    END { \
        printf("\n];\n"); \
    }' > list.js



chmod -R 777 img
chmod -R 777 list.js

rm -rf /var/www/jimcoggeshall.com/paper/img || :
mv img /var/www/jimcoggeshall.com/paper
rm -rf /var/www/jimcoggeshall.com/paper/list.js || :
mv list.js /var/www/jimcoggeshall.com/paper

popd

rm -rf "$workdir"

sleep 60
