#!/bin/bash

set -x

workdir=$(uuidgen)
mkdir -p "$workdir"
pushd "$workdir"

mkdir -p img
pushd img

wget -N https://cloud.jimcoggeshall.com/TodaysPaper.pdf 
pdfseparate TodaysPaper.pdf TodaysPaper%03d.pdf
rm -f TodaysPaper.pdf

find . -name '*.pdf' | while read f; do
    echo "$f"
    pdftocairo -png -r 150 "$f" "$(basename $f '.pdf').png"
    rm -f "$f"
done

popd

find img -name '*.png' |\
    sort -n |\
	   awk 'BEGIN { \
        printf("var pagesOrig = [\n"); \
    } \
    NR == 1 { \
        printf("  \"%s\"", $0); \
    } \
    NR > 1 { \
        printf(",\n  \"%s\"", $0); \
    } \
    END { \
        printf("\n];\n"); \
    }' > list.js

rm -rf /var/www/jimcoggeshall.com/paper/img
rm -rf /var/www/jimcoggeshall.com/paper/list.js
chmod -R 777 img
chmod -R 777 list.js
mv img /var/www/jimcoggeshall.com/paper
mv list.js /var/www/jimcoggeshall.com/paper

popd

rm -rf "$workdir"

sleep 3600
